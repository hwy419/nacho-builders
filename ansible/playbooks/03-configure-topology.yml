---
# Configure Cardano node topology
# Sets up P2P topology for relays and BP connections
#
# Usage: ansible-playbook playbooks/03-configure-topology.yml

- name: Configure Cardano topology
  hosts: cardano
  gather_facts: true
  become: true
  vars_files:
    - ../inventory/group_vars/cardano.yml

  tasks:
    # ============================================
    # P2P Topology Configuration
    # ============================================
    - name: Create topology.json for Block Producer
      when: cardano_node_type == 'producer'
      copy:
        dest: "{{ cardano_config_dir }}/topology.json"
        content: |
          {
            "bootstrapPeers": null,
            "localRoots": [
              {
                "accessPoints": [
                  {
                    "address": "192.168.160.11",
                    "port": 6000
                  },
                  {
                    "address": "192.168.160.12",
                    "port": 6000
                  }
                ],
                "advertise": false,
                "trustable": true,
                "valency": 2
              }
            ],
            "publicRoots": [],
            "useLedgerAfterSlot": -1
          }
        owner: cardano
        group: cardano
        mode: '0644'
      notify: Restart cnode

    - name: Create topology.json for Relay 1
      when: cardano_node_type == 'relay' and inventory_hostname == 'cardano-relay1'
      copy:
        dest: "{{ cardano_config_dir }}/topology.json"
        content: |
          {
            "bootstrapPeers": [
              {
                "address": "backbone.cardano.iog.io",
                "port": 3001
              },
              {
                "address": "backbone.mainnet.emurgornd.com",
                "port": 3001
              }
            ],
            "localRoots": [
              {
                "accessPoints": [
                  {
                    "address": "192.168.160.10",
                    "port": 6000
                  }
                ],
                "advertise": false,
                "trustable": true,
                "valency": 1
              },
              {
                "accessPoints": [
                  {
                    "address": "192.168.160.12",
                    "port": 6000
                  }
                ],
                "advertise": false,
                "trustable": true,
                "valency": 1
              }
            ],
            "publicRoots": [
              {
                "accessPoints": [
                  {
                    "address": "backbone.cardano.iog.io",
                    "port": 3001
                  }
                ],
                "advertise": false
              }
            ],
            "useLedgerAfterSlot": 87024000
          }
        owner: cardano
        group: cardano
        mode: '0644'
      notify: Restart cnode

    - name: Create topology.json for Relay 2
      when: cardano_node_type == 'relay' and inventory_hostname == 'cardano-relay2'
      copy:
        dest: "{{ cardano_config_dir }}/topology.json"
        content: |
          {
            "bootstrapPeers": [
              {
                "address": "backbone.cardano.iog.io",
                "port": 3001
              },
              {
                "address": "backbone.mainnet.emurgornd.com",
                "port": 3001
              }
            ],
            "localRoots": [
              {
                "accessPoints": [
                  {
                    "address": "192.168.160.10",
                    "port": 6000
                  }
                ],
                "advertise": false,
                "trustable": true,
                "valency": 1
              },
              {
                "accessPoints": [
                  {
                    "address": "192.168.160.11",
                    "port": 6000
                  }
                ],
                "advertise": false,
                "trustable": true,
                "valency": 1
              }
            ],
            "publicRoots": [
              {
                "accessPoints": [
                  {
                    "address": "backbone.cardano.iog.io",
                    "port": 3001
                  }
                ],
                "advertise": false
              }
            ],
            "useLedgerAfterSlot": 87024000
          }
        owner: cardano
        group: cardano
        mode: '0644'
      notify: Restart cnode

  handlers:
    - name: Restart cnode
      systemd:
        name: cnode
        state: restarted
