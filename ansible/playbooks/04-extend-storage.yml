---
# Extend LVM storage on Cardano nodes
# 
# PREREQUISITE: First resize the VM disks in Proxmox:
#   qm resize 111 scsi0 +150G
#   qm resize 112 scsi0 +150G
#   qm resize 113 scsi0 +150G
#
# Usage: ansible-playbook playbooks/04-extend-storage.yml

- name: Extend LVM storage on Cardano nodes
  hosts: cardano
  gather_facts: true
  become: true

  tasks:
    - name: Get current disk usage before extension
      command: df -h /
      register: disk_before
      changed_when: false

    - name: Display current disk usage
      debug:
        msg: "{{ disk_before.stdout_lines }}"

    - name: Rescan SCSI devices for new disk size
      shell: |
        echo 1 > /sys/class/block/sda/device/rescan
      changed_when: true

    - name: Wait for kernel to recognize new size
      pause:
        seconds: 3

    - name: Extend the partition using growpart
      command: growpart /dev/sda 3
      register: growpart_result
      changed_when: "'CHANGED' in growpart_result.stdout"
      failed_when: 
        - growpart_result.rc != 0
        - "'NOCHANGE' not in growpart_result.stdout"

    - name: Resize the physical volume
      command: pvresize /dev/sda3
      register: pvresize_result
      changed_when: "'successfully resized' in pvresize_result.stdout"

    - name: Extend the logical volume to use all free space
      command: lvextend -l +100%FREE /dev/mapper/ubuntu--vg-ubuntu--lv
      register: lvextend_result
      changed_when: "'successfully resized' in lvextend_result.stdout"
      failed_when:
        - lvextend_result.rc != 0
        - "'matches existing size' not in lvextend_result.stderr"

    - name: Resize the filesystem
      command: resize2fs /dev/mapper/ubuntu--vg-ubuntu--lv
      register: resize2fs_result
      changed_when: "'Nothing to do' not in resize2fs_result.stdout"

    - name: Get disk usage after extension
      command: df -h /
      register: disk_after
      changed_when: false

    - name: Display new disk usage
      debug:
        msg: "{{ disk_after.stdout_lines }}"

    - name: Summary
      debug:
        msg: |
          Storage extension complete on {{ inventory_hostname }}
          Before: {{ disk_before.stdout_lines[-1] }}
          After:  {{ disk_after.stdout_lines[-1] }}

