#!/bin/bash
# Configure Kong Gateway with services, routes, and plugins
# This script is idempotent and can be run multiple times

set -e

KONG_ADMIN="http://localhost:8001"

echo "Waiting for Kong to be ready..."
until curl -s $KONG_ADMIN/status > /dev/null 2>&1; do
  sleep 2
done
echo "Kong is ready!"

echo "Configuring Kong Gateway..."

# ============================================
# Create Upstreams with targets (for load balancing)
# ============================================

# Ogmios upstream - routes through local caching proxy
# The proxy handles Redis caching and load balances to relays
curl -s -X PUT $KONG_ADMIN/upstreams/ogmios-upstream \
  --data name=ogmios-upstream \
  > /dev/null || true

# Route to local caching proxy (port 3001)
curl -s -X POST $KONG_ADMIN/upstreams/ogmios-upstream/targets \
  --data target=127.0.0.1:3001 \
  --data weight=100 \
  > /dev/null 2>&1 || true

# Note: Direct relay targets removed - proxy handles load balancing to:
#   - 192.168.160.11:1337
#   - 192.168.160.12:1337

# Submit API upstream
curl -s -X PUT $KONG_ADMIN/upstreams/submit-upstream \
  --data name=submit-upstream \
  > /dev/null || true

curl -s -X POST $KONG_ADMIN/upstreams/submit-upstream/targets \
  --data target=192.168.160.11:8090 \
  --data weight=100 \
  > /dev/null 2>&1 || true

curl -s -X POST $KONG_ADMIN/upstreams/submit-upstream/targets \
  --data target=192.168.160.12:8090 \
  --data weight=100 \
  > /dev/null 2>&1 || true

# ============================================
# Create Services (pointing to upstreams)
# ============================================

# Ogmios v1 (routes through caching proxy)
curl -s -X PUT $KONG_ADMIN/services/ogmios \
  --data name=ogmios \
  --data host=ogmios-upstream \
  --data port=3001 \
  --data protocol=http \
  --data retries=5 \
  --data connect_timeout=60000 \
  --data write_timeout=60000 \
  --data read_timeout=60000 \
  > /dev/null
echo "✓ Ogmios service configured (via caching proxy)"

# Submit API v1 (uses upstream)
curl -s -X PUT $KONG_ADMIN/services/submit-api \
  --data name=submit-api \
  --data host=submit-upstream \
  --data port=8090 \
  --data protocol=http \
  --data path=/api/submit/tx \
  > /dev/null
echo "✓ Submit API service configured"

# ============================================
# Create Routes
# ============================================

# Ogmios route
curl -s -X PUT $KONG_ADMIN/services/ogmios/routes/ogmios-route \
  --data name=ogmios-route \
  --data 'paths[]=/v1/ogmios' \
  --data strip_path=true \
  --data preserve_host=false \
  --data 'protocols[]=http' \
  --data 'protocols[]=https' \
  > /dev/null
echo "✓ Ogmios route configured"

# Submit API route
curl -s -X PUT $KONG_ADMIN/services/submit-api/routes/submit-route \
  --data name=submit-route \
  --data 'paths[]=/v1/submit' \
  --data strip_path=true \
  --data 'protocols[]=http' \
  --data 'protocols[]=https' \
  > /dev/null
echo "✓ Submit route configured"

# ============================================
# PREPROD TESTNET CONFIGURATION
# ============================================

# Preprod Ogmios upstream - routes through local caching proxy (port 3002)
curl -s -X PUT $KONG_ADMIN/upstreams/ogmios-preprod-upstream \
  --data name=ogmios-preprod-upstream \
  > /dev/null || true

curl -s -X POST $KONG_ADMIN/upstreams/ogmios-preprod-upstream/targets \
  --data target=127.0.0.1:3002 \
  --data weight=100 \
  > /dev/null 2>&1 || true

# Preprod Submit API upstream (direct to preprod relay)
curl -s -X PUT $KONG_ADMIN/upstreams/submit-preprod-upstream \
  --data name=submit-preprod-upstream \
  > /dev/null || true

curl -s -X POST $KONG_ADMIN/upstreams/submit-preprod-upstream/targets \
  --data target={{ cardano_preprod_relay1_submit }} \
  --data weight=100 \
  > /dev/null 2>&1 || true

# Preprod Ogmios service (routes through caching proxy on port 3002)
curl -s -X PUT $KONG_ADMIN/services/ogmios-preprod \
  --data name=ogmios-preprod \
  --data host=ogmios-preprod-upstream \
  --data port=3002 \
  --data protocol=http \
  --data retries=5 \
  --data connect_timeout=60000 \
  --data write_timeout=60000 \
  --data read_timeout=60000 \
  > /dev/null
echo "✓ Preprod Ogmios service configured (via caching proxy)"

# Preprod Submit API service
curl -s -X PUT $KONG_ADMIN/services/submit-api-preprod \
  --data name=submit-api-preprod \
  --data host=submit-preprod-upstream \
  --data port=8090 \
  --data protocol=http \
  --data path=/api/submit/tx \
  > /dev/null
echo "✓ Preprod Submit API service configured"

# Preprod Ogmios route
curl -s -X PUT $KONG_ADMIN/services/ogmios-preprod/routes/ogmios-preprod-route \
  --data name=ogmios-preprod-route \
  --data 'paths[]=/v1/preprod/ogmios' \
  --data strip_path=true \
  --data preserve_host=false \
  --data 'protocols[]=http' \
  --data 'protocols[]=https' \
  > /dev/null
echo "✓ Preprod Ogmios route configured"

# Preprod Submit API route
curl -s -X PUT $KONG_ADMIN/services/submit-api-preprod/routes/submit-preprod-route \
  --data name=submit-preprod-route \
  --data 'paths[]=/v1/preprod/submit' \
  --data strip_path=true \
  --data 'protocols[]=http' \
  --data 'protocols[]=https' \
  > /dev/null
echo "✓ Preprod Submit route configured"

# ============================================
# Add Global Plugins (applied to all services)
# ============================================

# Key-auth plugin (global) - validates API keys from header
curl -s -X POST $KONG_ADMIN/plugins \
  --data name=key-auth \
  --data 'config.key_names[]=apikey' \
  --data config.key_in_header=true \
  --data config.key_in_query=true \
  --data config.key_in_body=false \
  --data config.hide_credentials=false \
  > /dev/null 2>&1 || true
echo "✓ Key-auth plugin configured"

# Rate-limiting plugin (global) - default limits
curl -s -X POST $KONG_ADMIN/plugins \
  --data name=rate-limiting \
  --data config.minute=60 \
  --data config.hour=1000 \
  --data config.policy=local \
  --data config.fault_tolerant=true \
  --data config.limit_by=consumer \
  --data 'config.error_message=API rate limit exceeded' \
  > /dev/null 2>&1 || true
echo "✓ Rate-limiting plugin configured"

# Prometheus plugin (global metrics)
curl -s -X POST $KONG_ADMIN/plugins \
  --data name=prometheus \
  > /dev/null 2>&1 || true
echo "✓ Prometheus plugin configured"

# HTTP log plugin (for usage tracking to web app)
curl -s -X POST $KONG_ADMIN/plugins \
  --data name=http-log \
  --data config.http_endpoint=http://localhost:3000/api/usage/log \
  --data config.method=POST \
  --data config.timeout=10000 \
  --data config.keepalive=60000 \
  > /dev/null 2>&1 || true
echo "✓ HTTP log plugin configured"

# ============================================
# Create test consumer (for development)
# ============================================

# Create a test consumer
curl -s -X PUT $KONG_ADMIN/consumers/test-user \
  --data username=test-user \
  --data custom_id=test \
  > /dev/null
echo "✓ Test consumer created"

# Create a test API key for the consumer
curl -s -X POST $KONG_ADMIN/consumers/test-user/key-auth \
  --data key=test-api-key-12345 \
  > /dev/null 2>&1 || true
echo "✓ Test API key created (key: test-api-key-12345)"

echo
echo "============================================"
echo "✅ Kong configuration complete!"
echo "============================================"
echo
echo "Kong Admin API: http://localhost:8001"
echo "Kong Proxy: http://localhost:8000"
echo "Prometheus metrics: http://localhost:8001/metrics"
echo
echo "Test your API:"
echo "  Mainnet: curl -H 'apikey: test-api-key-12345' http://localhost:8000/v1/ogmios"
echo "  Preprod: curl -H 'apikey: test-api-key-12345' http://localhost:8000/v1/preprod/ogmios"
echo
echo "Routes:"
echo "  /v1/ogmios         → Mainnet Ogmios (via cache proxy port 3001)"
echo "  /v1/submit         → Mainnet Submit API"
echo "  /v1/preprod/ogmios → Preprod Ogmios (via cache proxy port 3002)"
echo "  /v1/preprod/submit → Preprod Submit API"
echo
echo "NOTE: Production API keys are synced from the web app database."
echo "      Use the sync-kong-keys.sh script to manually sync if needed."




