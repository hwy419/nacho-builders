#!/bin/bash
# Configure Kong Gateway with services, routes, and plugins
# This script is idempotent and can be run multiple times

set -e

KONG_ADMIN="http://localhost:8001"

echo "Waiting for Kong to be ready..."
until curl -s $KONG_ADMIN/status > /dev/null 2>&1; do
  sleep 2
done
echo "Kong is ready!"

echo "Configuring Kong Gateway..."

# ============================================
# Create Upstreams with targets (for load balancing)
# ============================================

# Ogmios upstream - routes through local caching proxy
# The proxy handles Redis caching and load balances to relays
curl -s -X PUT $KONG_ADMIN/upstreams/ogmios-upstream \
  --data name=ogmios-upstream \
  > /dev/null || true

# Route to local caching proxy (port 3001)
curl -s -X POST $KONG_ADMIN/upstreams/ogmios-upstream/targets \
  --data target=127.0.0.1:3001 \
  --data weight=100 \
  > /dev/null 2>&1 || true

# Note: Direct relay targets removed - proxy handles load balancing to:
#   - 192.168.160.11:1337
#   - 192.168.160.12:1337

# Submit API upstream
curl -s -X PUT $KONG_ADMIN/upstreams/submit-upstream \
  --data name=submit-upstream \
  > /dev/null || true

curl -s -X POST $KONG_ADMIN/upstreams/submit-upstream/targets \
  --data target=192.168.160.11:8090 \
  --data weight=100 \
  > /dev/null 2>&1 || true

curl -s -X POST $KONG_ADMIN/upstreams/submit-upstream/targets \
  --data target=192.168.160.12:8090 \
  --data weight=100 \
  > /dev/null 2>&1 || true

# ============================================
# Create Services (pointing to upstreams)
# ============================================

# Ogmios v1 (routes through caching proxy)
curl -s -X PUT $KONG_ADMIN/services/ogmios \
  --data name=ogmios \
  --data host=ogmios-upstream \
  --data port=3001 \
  --data protocol=http \
  --data retries=5 \
  --data connect_timeout=60000 \
  --data write_timeout=60000 \
  --data read_timeout=60000 \
  > /dev/null
echo "✓ Ogmios service configured (via caching proxy)"

# Submit API v1 (uses upstream)
curl -s -X PUT $KONG_ADMIN/services/submit-api \
  --data name=submit-api \
  --data host=submit-upstream \
  --data port=8090 \
  --data protocol=http \
  --data path=/api/submit/tx \
  > /dev/null
echo "✓ Submit API service configured"

# ============================================
# Create Routes
# ============================================

# Ogmios route
curl -s -X PUT $KONG_ADMIN/services/ogmios/routes/ogmios-route \
  --data name=ogmios-route \
  --data 'paths[]=/v1/ogmios' \
  --data strip_path=true \
  --data preserve_host=false \
  --data 'protocols[]=http' \
  --data 'protocols[]=https' \
  > /dev/null
echo "✓ Ogmios route configured"

# Submit API route
curl -s -X PUT $KONG_ADMIN/services/submit-api/routes/submit-route \
  --data name=submit-route \
  --data 'paths[]=/v1/submit' \
  --data strip_path=true \
  --data 'protocols[]=http' \
  --data 'protocols[]=https' \
  > /dev/null
echo "✓ Submit route configured"

# ============================================
# DB-SYNC SERVICES (for fast UTxO lookups)
# ============================================

# DB-Sync upstream (routes to web app API)
curl -s -X PUT $KONG_ADMIN/upstreams/dbsync-upstream \
  --data name=dbsync-upstream \
  > /dev/null || true

curl -s -X POST $KONG_ADMIN/upstreams/dbsync-upstream/targets \
  --data target=127.0.0.1:3000 \
  --data weight=100 \
  > /dev/null 2>&1 || true

# DB-Sync UTxO service
curl -s -X PUT $KONG_ADMIN/services/dbsync-utxos \
  --data name=dbsync-utxos \
  --data host=dbsync-upstream \
  --data port=3000 \
  --data protocol=http \
  --data path=/api/dbsync/utxos \
  --data retries=3 \
  --data connect_timeout=10000 \
  --data write_timeout=30000 \
  --data read_timeout=30000 \
  > /dev/null
echo "✓ DB-Sync UTxO service configured"

# DB-Sync UTxO route (mainnet)
curl -s -X PUT $KONG_ADMIN/services/dbsync-utxos/routes/utxos-route \
  --data name=utxos-route \
  --data 'paths[]=/v1/utxos' \
  --data strip_path=true \
  --data preserve_host=false \
  --data 'protocols[]=http' \
  --data 'protocols[]=https' \
  > /dev/null
echo "✓ UTxO route configured (/v1/utxos)"

# ============================================
# GRAPHQL API CONFIGURATION
# ============================================

# GraphQL upstream (Hasura on DB-Sync server)
curl -s -X PUT $KONG_ADMIN/upstreams/graphql-upstream \
  --data name=graphql-upstream \
  > /dev/null || true

curl -s -X POST $KONG_ADMIN/upstreams/graphql-upstream/targets \
  --data target=192.168.170.20:3100 \
  --data weight=100 \
  > /dev/null 2>&1 || true

# GraphQL service (Mainnet - Hasura)
curl -s -X PUT $KONG_ADMIN/services/graphql \
  --data name=graphql \
  --data host=graphql-upstream \
  --data port=3100 \
  --data protocol=http \
  --data path=/v1/graphql \
  --data retries=3 \
  --data connect_timeout=10000 \
  --data write_timeout=60000 \
  --data read_timeout=60000 \
  > /dev/null
echo "✓ GraphQL service configured (Hasura on 192.168.170.20:3100)"

# GraphQL route (Mainnet)
curl -s -X PUT $KONG_ADMIN/services/graphql/routes/graphql-route \
  --data name=graphql-route \
  --data 'paths[]=/v1/graphql' \
  --data strip_path=false \
  --data preserve_host=false \
  --data 'protocols[]=http' \
  --data 'protocols[]=https' \
  > /dev/null
echo "✓ GraphQL route configured (/v1/graphql)"

# ============================================
# PREPROD TESTNET CONFIGURATION
# ============================================

# Preprod Ogmios upstream - routes through local caching proxy (port 3002)
curl -s -X PUT $KONG_ADMIN/upstreams/ogmios-preprod-upstream \
  --data name=ogmios-preprod-upstream \
  > /dev/null || true

curl -s -X POST $KONG_ADMIN/upstreams/ogmios-preprod-upstream/targets \
  --data target=127.0.0.1:3002 \
  --data weight=100 \
  > /dev/null 2>&1 || true

# Preprod Submit API upstream (direct to preprod relay)
curl -s -X PUT $KONG_ADMIN/upstreams/submit-preprod-upstream \
  --data name=submit-preprod-upstream \
  > /dev/null || true

curl -s -X POST $KONG_ADMIN/upstreams/submit-preprod-upstream/targets \
  --data target={{ cardano_preprod_relay1_submit }} \
  --data weight=100 \
  > /dev/null 2>&1 || true

# Preprod Ogmios service (routes through caching proxy on port 3002)
curl -s -X PUT $KONG_ADMIN/services/ogmios-preprod \
  --data name=ogmios-preprod \
  --data host=ogmios-preprod-upstream \
  --data port=3002 \
  --data protocol=http \
  --data retries=5 \
  --data connect_timeout=60000 \
  --data write_timeout=60000 \
  --data read_timeout=60000 \
  > /dev/null
echo "✓ Preprod Ogmios service configured (via caching proxy)"

# Preprod Submit API service
curl -s -X PUT $KONG_ADMIN/services/submit-api-preprod \
  --data name=submit-api-preprod \
  --data host=submit-preprod-upstream \
  --data port=8090 \
  --data protocol=http \
  --data path=/api/submit/tx \
  > /dev/null
echo "✓ Preprod Submit API service configured"

# Preprod Ogmios route
curl -s -X PUT $KONG_ADMIN/services/ogmios-preprod/routes/ogmios-preprod-route \
  --data name=ogmios-preprod-route \
  --data 'paths[]=/v1/preprod/ogmios' \
  --data strip_path=true \
  --data preserve_host=false \
  --data 'protocols[]=http' \
  --data 'protocols[]=https' \
  > /dev/null
echo "✓ Preprod Ogmios route configured"

# Preprod Submit API route
curl -s -X PUT $KONG_ADMIN/services/submit-api-preprod/routes/submit-preprod-route \
  --data name=submit-preprod-route \
  --data 'paths[]=/v1/preprod/submit' \
  --data strip_path=true \
  --data 'protocols[]=http' \
  --data 'protocols[]=https' \
  > /dev/null
echo "✓ Preprod Submit route configured"

# Preprod GraphQL upstream (Hasura on DB-Sync server port 3101)
curl -s -X PUT $KONG_ADMIN/upstreams/graphql-preprod-upstream \
  --data name=graphql-preprod-upstream \
  > /dev/null || true

curl -s -X POST $KONG_ADMIN/upstreams/graphql-preprod-upstream/targets \
  --data target=192.168.170.20:3101 \
  --data weight=100 \
  > /dev/null 2>&1 || true

# Preprod GraphQL service (Hasura)
curl -s -X PUT $KONG_ADMIN/services/graphql-preprod \
  --data name=graphql-preprod \
  --data host=graphql-preprod-upstream \
  --data port=3101 \
  --data protocol=http \
  --data path=/v1/graphql \
  --data retries=3 \
  --data connect_timeout=10000 \
  --data write_timeout=60000 \
  --data read_timeout=60000 \
  > /dev/null
echo "✓ Preprod GraphQL service configured (Hasura on 192.168.170.20:3101)"

# Preprod GraphQL route
curl -s -X PUT $KONG_ADMIN/services/graphql-preprod/routes/graphql-preprod-route \
  --data name=graphql-preprod-route \
  --data 'paths[]=/v1/preprod/graphql' \
  --data strip_path=false \
  --data preserve_host=false \
  --data 'protocols[]=http' \
  --data 'protocols[]=https' \
  > /dev/null
echo "✓ Preprod GraphQL route configured (/v1/preprod/graphql)"

# ============================================
# Add Route-Specific Plugins (authentication and CORS)
# ============================================

INTERNAL_SECRET="{{ vault_kong_internal_secret | default('change-me-in-production') }}"

# Function to add cardano-api-auth plugin to a route
add_auth_plugin() {
  local route_name=$1
  curl -s -X POST $KONG_ADMIN/routes/$route_name/plugins \
    --data name=cardano-api-auth \
    --data-urlencode "config.internal_secret=$INTERNAL_SECRET" \
    --data config.timeout=5000 \
    --data config.cache_ttl=60 \
    --data 'config.auth_url=http://localhost:3000/api/auth/validate-key' \
    --data config.key_header=apikey \
    --data config.key_in_query=true \
    --data config.key_param=apikey \
    > /dev/null 2>&1 || true
}

# Function to add CORS plugin to a route
add_cors_plugin() {
  local route_name=$1
  curl -s -X POST $KONG_ADMIN/routes/$route_name/plugins \
    --data name=cors \
    --data 'config.origins=*' \
    --data 'config.methods=GET,POST,OPTIONS' \
    --data 'config.headers=Accept,Authorization,Content-Type,apikey' \
    --data 'config.exposed_headers=X-Request-Id' \
    --data config.credentials=true \
    --data config.max_age=3600 \
    > /dev/null 2>&1 || true
}

# Add auth and CORS to Mainnet routes
add_auth_plugin "ogmios-route"
add_cors_plugin "ogmios-route"
echo "✓ Ogmios route plugins configured"

add_auth_plugin "submit-route"
add_cors_plugin "submit-route"
echo "✓ Submit route plugins configured"

add_auth_plugin "utxos-route"
add_cors_plugin "utxos-route"
echo "✓ UTxO route plugins configured"

add_auth_plugin "graphql-route"
add_cors_plugin "graphql-route"
echo "✓ GraphQL route plugins configured"

# Add auth and CORS to Preprod routes
add_auth_plugin "ogmios-preprod-route"
add_cors_plugin "ogmios-preprod-route"
echo "✓ Preprod Ogmios route plugins configured"

add_auth_plugin "submit-preprod-route"
add_cors_plugin "submit-preprod-route"
echo "✓ Preprod Submit route plugins configured"

add_auth_plugin "graphql-preprod-route"
add_cors_plugin "graphql-preprod-route"
echo "✓ Preprod GraphQL route plugins configured"

# ============================================
# Add Global Plugins
# ============================================

# Rate-limiting plugin (global) - default limits
curl -s -X POST $KONG_ADMIN/plugins \
  --data name=rate-limiting \
  --data config.minute=60 \
  --data config.hour=1000 \
  --data config.policy=local \
  --data config.fault_tolerant=true \
  --data config.limit_by=consumer \
  --data 'config.error_message=API rate limit exceeded' \
  > /dev/null 2>&1 || true
echo "✓ Rate-limiting plugin configured"

# Prometheus plugin (global metrics)
curl -s -X POST $KONG_ADMIN/plugins \
  --data name=prometheus \
  > /dev/null 2>&1 || true
echo "✓ Prometheus plugin configured"

# HTTP log plugin (for usage tracking to web app)
curl -s -X POST $KONG_ADMIN/plugins \
  --data name=http-log \
  --data config.http_endpoint=http://localhost:3000/api/usage/log \
  --data config.method=POST \
  --data config.timeout=10000 \
  --data config.keepalive=60000 \
  > /dev/null 2>&1 || true
echo "✓ HTTP log plugin configured"

echo
echo "============================================"
echo "✅ Kong configuration complete!"
echo "============================================"
echo
echo "Kong Admin API: http://localhost:8001"
echo "Kong Proxy: http://localhost:8000"
echo "Prometheus metrics: http://localhost:8001/metrics"
echo
echo "Routes (all require valid API key):"
echo "  /v1/ogmios          → Mainnet Ogmios (via cache proxy port 3001)"
echo "  /v1/submit          → Mainnet Submit API"
echo "  /v1/utxos           → DB-Sync UTxO lookups (fast ~10ms queries)"
echo "  /v1/graphql         → GraphQL API (Hasura on 192.168.170.20:3100)"
echo "  /v1/preprod/ogmios  → Preprod Ogmios (via cache proxy port 3002)"
echo "  /v1/preprod/submit  → Preprod Submit API"
echo "  /v1/preprod/graphql → Preprod GraphQL (Hasura on 192.168.170.20:3101)"
echo
echo "NOTE: API keys are validated via the web app at /api/auth/validate-key."
echo "      Create keys via the dashboard at app.nacho.builders."






