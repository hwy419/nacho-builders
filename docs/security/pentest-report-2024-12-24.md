# Cardano Stake Pool Penetration Test Report
## NACHO Pool (nacho.builders)

**Test Date:** December 24, 2024  
**Test Type:** Grey-box penetration test  
**Environment:** Production mainnet infrastructure  
**Tester:** Automated security assessment  

---

## Executive Summary

A comprehensive penetration test was conducted against the NACHO Cardano stake pool infrastructure. The assessment covered external attack surfaces, network segmentation, host security, Cardano-specific configurations, privilege management, and logging capabilities.

### Overall Security Posture: **STRONG**

The infrastructure demonstrates a well-designed defense-in-depth approach with proper network segmentation, hardened hosts, and Cardano-specific security controls.

### Key Findings Summary

| Severity | Count | Description |
|----------|-------|-------------|
| CRITICAL | 0 | No critical vulnerabilities found |
| HIGH | 0 | No high-severity issues found |
| MEDIUM | 2 | NOPASSWD sudo configuration |
| LOW | 1 | PeerSharing disabled on relays |
| INFO | 3 | Informational observations |

---

## Infrastructure Tested

```
                                INTERNET
                                    │
                                    │ WAN: 108.248.110.80
                                    │
                          ┌─────────▼─────────┐
                          │  UniFi DR7        │
                          │  Port Forwards:   │
                          │  6001 → Relay1    │
                          │  6002 → Relay2    │
                          └─────────┬─────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
            VLAN 1 (LAN)    VLAN 160 (Cardano)   VLAN 170
            192.168.150.0/24  192.168.160.0/24   (Future)
                    │               │
                    │    ┌──────────┴──────────┐
                    │    │                     │
               ┌────▼────▼────┐    ┌───────────▼───────────┐
               │   Relay 1    │    │      Relay 2          │
               │  .160.11     │    │      .160.12          │
               └──────┬───────┘    └───────────┬───────────┘
                      │                        │
                      └──────────┬─────────────┘
                                 │
                      ┌──────────▼──────────┐
                      │   Block Producer    │
                      │      .160.10        │
                      └─────────────────────┘
```

---

## Phase 1: External Attack Surface Assessment

### DNS Reconnaissance

| Test | Result | Status |
|------|--------|--------|
| Zone transfer attempt | Refused | ✅ PASS |
| DNS records exposed | Only relay CNAMEs | ✅ PASS |
| Internal IPs leaked | None | ✅ PASS |
| NS records | AWS Route53 | ✅ PASS |

**Findings:**
- `nacho.builders:6001` → Relay 1 → `108.248.110.80`
- `nacho.builders:6002` → Relay 2 → `108.248.110.80`
- Reverse DNS: `108-248-110-80.lightspeed.rcsntx.sbcglobal.net` (AT&T Business)

### External Port Scan

| Port | Service | Expected | Actual | Status |
|------|---------|----------|--------|--------|
| 6001 | Cardano Relay1 | Open | Open | ✅ PASS |
| 6002 | Cardano Relay2 | Open | Open | ✅ PASS |
| 22 | SSH | Closed | Closed | ✅ PASS |
| 6000 | BP Direct | Closed | Closed | ✅ PASS |
| 80 | HTTP | Closed | Closed | ✅ PASS |
| 443 | HTTPS | Closed | Closed | ✅ PASS |
| 12798 | Prometheus | Closed | Closed | ✅ PASS |

### Protocol Testing

| Test | Result | Status |
|------|--------|--------|
| Prometheus metrics externally | Not accessible | ✅ PASS |
| Cardano protocol on 6001 | Responds correctly | ✅ PASS |
| Cardano protocol on 6002 | Responds correctly | ✅ PASS |

---

## Phase 2: Network Segmentation Testing

### VLAN Isolation

| Source | Destination | Expected | Actual | Status |
|--------|-------------|----------|--------|--------|
| BP → LAN (192.168.150.222) | Blocked | 100% packet loss | ✅ PASS |
| BP → VPN (192.168.2.1) | Blocked | 100% packet loss | ✅ PASS |
| BP → Internet (1.1.1.1) | Allowed | Connected | ✅ PASS |

### Inter-Node Communication

| Source | Destination | Port | Result | Status |
|--------|-------------|------|--------|--------|
| BP → Relay1 | 6000 | Connected | ✅ PASS |
| BP → Relay2 | 6000 | Connected | ✅ PASS |
| Relay1 → BP | 6000 | Connected | ✅ PASS |
| Relay2 → BP | 6000 | Connected | ✅ PASS |
| Relay1 → Relay2 | 6000 | Connected | ✅ PASS |

### Lateral Movement Prevention

| Source | Destination | Port | Result | Status |
|--------|-------------|------|--------|--------|
| Relay1 → BP | 22 (SSH) | Blocked | ✅ PASS |
| Relay1 → BP | 80 | Blocked | ✅ PASS |
| Relay1 → BP | 443 | Blocked | ✅ PASS |
| Relay1 → BP | 3000 | Blocked | ✅ PASS |
| Relay1 → BP | 9090 | Blocked | ✅ PASS |

**Key Finding:** Even if a relay is compromised, the attacker cannot SSH to the Block Producer. Only port 6000 (Cardano protocol) is accessible between nodes.

---

## Phase 3: Host Security Assessment

### SSH Configuration

| Setting | Expected | Relay1 | Relay2 | Status |
|---------|----------|--------|--------|--------|
| PasswordAuthentication | no | no | no | ✅ PASS |
| PermitRootLogin | no | no | no | ✅ PASS |
| MaxAuthTries | 3 | 3 | 3 | ✅ PASS |
| X11Forwarding | no | no | no | ✅ PASS |
| AllowTcpForwarding | no | no | no | ✅ PASS |

**SSH Version:** OpenSSH_8.9p1 Ubuntu-3ubuntu0.13 (current, no known critical CVEs)

### UFW Firewall Rules

**Relay Nodes:**
```
Status: active
Default: deny (incoming), allow (outgoing)

22/tcp    ALLOW IN    192.168.150.0/24   # SSH from LAN
22/tcp    ALLOW IN    192.168.2.0/24     # SSH from VPN
6000/tcp  ALLOW IN    Anywhere           # Cardano P2P
12798/tcp ALLOW IN    192.168.150.0/24   # Prometheus from LAN
12798/tcp ALLOW IN    192.168.2.0/24     # Prometheus from VPN
```

### Fail2ban

| Setting | Value | Status |
|---------|-------|--------|
| Service | Active | ✅ PASS |
| SSH jail | Enabled | ✅ PASS |
| maxretry | 3 | ✅ PASS |
| bantime | 3600s | ✅ PASS |
| findtime | 600s | ✅ PASS |

**Verification:** During testing, fail2ban successfully blocked our IP after failed password authentication attempts on the Block Producer. This confirms the detection and response mechanism is working.

### Kernel Hardening

| Parameter | Expected | Actual | Status |
|-----------|----------|--------|--------|
| net.ipv4.tcp_syncookies | 1 | 1 | ✅ PASS |
| net.ipv4.icmp_echo_ignore_broadcasts | 1 | 1 | ✅ PASS |
| net.ipv4.conf.all.rp_filter | 1 | 1 | ✅ PASS |
| net.ipv4.conf.all.accept_source_route | 0 | 0 | ✅ PASS |
| net.ipv4.conf.all.send_redirects | 0 | 0 | ✅ PASS |

### Time Synchronization

| Metric | Value | Status |
|--------|-------|--------|
| Service | Chrony | ✅ PASS |
| Leap status | Normal | ✅ PASS |
| System time offset | 0.000175s | ✅ PASS |

---

## Phase 4: Cardano-Specific Security

### Key File Security

| Check | Relay1 | Relay2 | Status |
|-------|--------|--------|--------|
| .skey files present | None | None | ✅ PASS |
| cold.skey present | None | None | ✅ PASS |
| Keys in /tmp | None | None | ✅ PASS |

**Note:** Block Producer key verification was not possible during this test due to fail2ban blocking. Manual verification recommended.

### Topology Configuration

**Relay Nodes:**
- ✅ `bootstrapPeers` includes IOG backbone
- ✅ `localRoots` includes Block Producer (192.168.160.10)
- ✅ `useLedgerAfterSlot` > 0 (enables P2P discovery)
- ✅ `PeerSharing` disabled (conservative setting)

### Prometheus Metrics

| Test | Result | Status |
|------|--------|--------|
| Binding | 127.0.0.1:12798 only | ✅ PASS |
| Cross-node access | Blocked | ✅ PASS |
| External access | Blocked | ✅ PASS |

### Node Socket

| Check | Result | Status |
|-------|--------|--------|
| Socket type | Unix domain | ✅ PASS |
| Owner | cardano:cardano | ✅ PASS |
| Network exposure | None | ✅ PASS |

---

## Phase 5: Privilege Escalation Assessment

### User Privileges

| User | Sudo Access | NOPASSWD | Status |
|------|-------------|----------|--------|
| michael | ALL | Yes | ⚠️ MEDIUM |
| cardano | ALL | Yes | ⚠️ MEDIUM |
| root | N/A | N/A | ✅ N/A |

### Process Security

| Check | Result | Status |
|-------|--------|--------|
| cardano-node runs as | cardano (not root) | ✅ PASS |
| Systemd User= | cardano | ✅ PASS |
| Systemd Group= | cardano | ✅ PASS |

### File Permissions

| Check | Result | Status |
|-------|--------|--------|
| Config files owner | cardano:cardano | ✅ PASS |
| World-readable .skey | None | ✅ PASS |
| World-writable in /opt/cardano | None | ✅ PASS |

---

## Phase 6: Logging and Detection

### Log Coverage

| Log | Status | Retention |
|-----|--------|-----------|
| /var/log/auth.log | Active | 4 weeks |
| /var/log/fail2ban.log | Active | 4 weeks |
| /var/log/kern.log | Active | 4 weeks |
| journalctl -u cnode | Active | Persistent |

### Detection Capabilities

| Capability | Status |
|------------|--------|
| SSH login logging | ✅ Active |
| SSH key fingerprint logging | ✅ Active |
| Sudo command logging | ✅ Active |
| Fail2ban detection | ✅ Active (verified) |
| Log rotation | ✅ Configured |

---

## Phase 7: UniFi Firewall Audit

### Port Forwards

| External | Internal | Destination | Status |
|----------|----------|-------------|--------|
| 6001/TCP | 6000/TCP | 192.168.160.11 | ✅ Verified |
| 6002/TCP | 6000/TCP | 192.168.160.12 | ✅ Verified |
| None | N/A | Block Producer | ✅ Correct |
| None | N/A | SSH | ✅ Correct |

### Firewall Rules

All rules verified through functional testing:
- ✅ LAN → Cardano SSH: Allowed
- ✅ VPN → Cardano SSH: Allowed
- ✅ Cardano → LAN: Blocked
- ✅ Cardano → VPN: Blocked
- ✅ Cardano internal: Allowed
- ✅ Cardano → Internet: Allowed

---

## Findings and Recommendations

### MEDIUM Severity

#### M1: NOPASSWD Sudo Configuration

**Finding:** Both `michael` and `cardano` users have passwordless sudo access.

**Location:** 
- `/etc/sudoers.d/michael`
- `/etc/sudoers.d/cardano`

**Risk:** If an attacker gains shell access as either user, they can immediately escalate to root without any additional authentication barrier.

**Recommendation:**
1. Remove NOPASSWD from both users
2. For `cardano` user, limit sudo to specific required commands:
   ```
   cardano ALL=(ALL) NOPASSWD: /bin/systemctl restart cnode, /bin/systemctl stop cnode, /bin/systemctl start cnode
   ```
3. For `michael` user, require password for sudo:
   ```
   michael ALL=(ALL) ALL
   ```

---

### LOW Severity

#### L1: PeerSharing Disabled on Relays

**Finding:** `PeerSharing` is set to `false` in relay configuration.

**Impact:** Reduces pool discoverability in the P2P network.

**Recommendation:** Consider enabling PeerSharing on relay nodes for better network participation:
```json
"PeerSharing": true
```

---

### Informational

#### I1: Block Producer Testing Incomplete

**Observation:** The Block Producer became inaccessible during testing due to fail2ban correctly blocking the testing IP after failed password authentication attempts.

**Recommendation:** Manually verify the following on the Block Producer:
- Key file permissions (should be 400)
- No cold keys present
- Topology configuration (`useLedgerAfterSlot: -1`)
- `PeerSharing: false`

#### I2: Reverse DNS Reveals ISP

**Observation:** Reverse DNS lookup reveals AT&T as the ISP: `108-248-110-80.lightspeed.rcsntx.sbcglobal.net`

**Impact:** Low - This is standard behavior and does not expose sensitive information.

#### I3: SUID Binaries Present

**Observation:** Standard SUID binaries are present on the system (sudo, mount, passwd, etc.)

**Impact:** None - These are expected system binaries.

---

## Test Execution Checklist

| Phase | Test | Expected | Actual | Pass/Fail |
|-------|------|----------|--------|-----------|
| 1.1 | DNS Zone Transfer | Refused | Refused | ✅ PASS |
| 1.2 | External Port Scan | Only 6001, 6002 | Only 6001, 6002 | ✅ PASS |
| 1.2 | BP Not Externally Accessible | Blocked | Blocked | ✅ PASS |
| 1.3 | Metrics Not Exposed Externally | Timeout | Timeout | ✅ PASS |
| 2.1 | Cardano to LAN Blocked | Blocked | Blocked | ✅ PASS |
| 2.1 | Cardano to VPN Blocked | Blocked | Blocked | ✅ PASS |
| 2.2 | BP ↔ Relays Connected | Connected | Connected | ✅ PASS |
| 2.3 | Relay → BP SSH Blocked | Blocked | Blocked | ✅ PASS |
| 3.1 | SSH Password Auth Disabled | Disabled | Disabled | ✅ PASS |
| 3.2 | UFW Rules Correct | Match spec | Match spec | ✅ PASS |
| 3.3 | Fail2ban Active | Active | Active (verified) | ✅ PASS |
| 4.1 | No Keys on Relays | None | None | ✅ PASS |
| 4.2 | Relay Topology Correct | Correct | Correct | ✅ PASS |
| 4.3 | Metrics Internal Only | Localhost only | Localhost only | ✅ PASS |
| 5.1 | Node runs as non-root | cardano | cardano | ✅ PASS |
| 6.1 | Logging Active | Active | Active | ✅ PASS |
| 7.1 | Port Forwards Correct | Verified | Verified | ✅ PASS |

---

## Conclusion

The NACHO Cardano stake pool infrastructure demonstrates a **strong security posture** with proper implementation of defense-in-depth principles:

1. **Network Security:** Excellent VLAN isolation, proper port forwarding, and firewall rules
2. **Host Security:** Well-hardened SSH, active fail2ban, kernel hardening applied
3. **Cardano Security:** Proper topology configuration, no sensitive keys on relays
4. **Detection:** Active logging and automated blocking of attacks

### Immediate Actions Required
1. Review and restrict NOPASSWD sudo access (MEDIUM)

### Recommended Improvements
1. Consider enabling PeerSharing on relays
2. Manually verify Block Producer key permissions and topology
3. Consider implementing centralized log aggregation for security monitoring

---

**Report Generated:** December 24, 2024  
**Next Recommended Test:** March 2025 (Quarterly)



